/*! Copyright (c) 2016 Ayogo Health Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to
 * deal in the Software without restriction, including without limitation the
 * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 */
angular.module('ayAccordion', [])
    .directive('ayAccordionRoot', function () {
    return {
        restrict: 'A',
        controller: function ($scope, $element, $attrs) {
            "ngInject";
            // Helper Methods //////////////////////////////////////////////////////
            var filter = Array.prototype.filter;
            var forEach = Array.prototype.forEach;
            var map = Array.prototype.map;
            var style = function (el, prop, value) {
                var vendors = ['', '-webkit-', '-ms-'];
                if (angular.isDefined(value)) {
                    for (var i = vendors.length - 1; i >= 0; --i) {
                        el.style[vendors[i] + prop] = value;
                    }
                }
                else {
                    for (var i = vendors.length - 1; i >= 0; --i) {
                        if (el.style[vendors[i] + prop] !== '') {
                            return el.style[vendors[i] + prop];
                        }
                    }
                    return null;
                }
            };
            // Controller-level Variables //////////////////////////////////////////
            this.root = $element[0];
            this.multiple = angular.isDefined($attrs['multiple']);
            this.curPanel = null;
            this.blockClicks = false;
            // Controller methods //////////////////////////////////////////////////
            this.run = function (fn, cb) {
                var self = this;
                self.blockClicks = true;
                var elementsToWatch = filter.call(self.root.childNodes, function (el) {
                    /* Disregard text nodes and comments */
                    return el.nodeType === 1;
                });
                var preRoot = self.root.getBoundingClientRect();
                self.root.style.minHeight = preRoot.height + 'px';
                /* Take initial measurements */
                var measurements = map.call(elementsToWatch, function (el) {
                    return {
                        el: el,
                        initialDimensions: el.getBoundingClientRect(),
                        initialTransform: style(el, 'transform') || ''
                    };
                });
                /* Close existing panels if needed */
                if (!this.multiple && this.curPanel && fn !== this.curPanel.close) {
                    this.curPanel.close();
                }
                /* Run the function to change the state */
                fn();
                /* Set the element states to appear as initial after the change */
                forEach.call(measurements, function (m) {
                    m.newDimensions = m.el.getBoundingClientRect();
                    m.newScale = {
                        x: m.initialDimensions.width / m.newDimensions.width,
                        y: m.initialDimensions.height / m.newDimensions.height
                    };
                    m.newOffset = {
                        x: m.initialDimensions.left - m.newDimensions.left,
                        y: m.initialDimensions.top - m.newDimensions.top
                    };
                    style(m.el, 'transform-origin', '0 0');
                    m.children = [];
                    /* Set the grandchildren to the inverse transform */
                    if (m.initialDimensions.height !== m.newDimensions.height ||
                        m.initialDimensions.width !== m.newDimensions.width) {
                        m.children = filter.call(m.el.childNodes, function (el) {
                            return el.nodeType === 1;
                        });
                        forEach.call(m.children, function (el) {
                            var elDimensions = el.getBoundingClientRect();
                            var offsetFromParent = {
                                x: m.newDimensions.left - elDimensions.left,
                                y: m.newDimensions.top - elDimensions.top
                            };
                            var origin = offsetFromParent.x + 'px ';
                            origin += offsetFromParent.y + 'px';
                            style(el, 'transform-origin', origin);
                        });
                    }
                });
                var duration = 100; // In milliseconds
                var t = 1;
                function tween() {
                    forEach.call(measurements, function (m) {
                        if (m.initialDimensions.height === m.newDimensions.height &&
                            m.initialDimensions.width === m.newDimensions.width &&
                            m.initialDimensions.left === m.newDimensions.left &&
                            m.initialDimensions.top === m.newDimensions.top) {
                            return;
                        }
                        var tScaleX = 1 + (m.newScale.x - 1) * t;
                        var tScaleY = 1 + (m.newScale.y - 1) * t;
                        var tOffsetX = m.newOffset.x * t;
                        var tOffsetY = m.newOffset.y * t;
                        var transform = 'translate(';
                        transform += tOffsetX + 'px, ';
                        transform += tOffsetY + 'px) ';
                        transform += 'scale(' + tScaleX + ',' + tScaleY + ') ';
                        transform += m.initialTransform;
                        style(m.el, 'transform', transform);
                        forEach.call(m.children, function (el) {
                            var scale = 'scale(' + (1 / tScaleX) + ',' + (1 / tScaleY) + ')';
                            style(el, 'transform', scale);
                        });
                    });
                    t -= (16 / duration);
                    if (t > 0) {
                        requestAnimationFrame(tween);
                    }
                    else {
                        cleanup();
                    }
                }
                tween();
                function cleanup() {
                    forEach.call(measurements, function (m) {
                        style(m.el, 'transform-origin', '');
                        style(m.el, 'transform', m.initialTransform);
                        forEach.call(m.children, function (el) {
                            style(el, 'transform-origin', '');
                            style(el, 'transform', '');
                        });
                    });
                    self.blockClicks = false;
                    self.root.style.minHeight = null;
                    /* Invoke our callback function when done */
                    $scope.$applyAsync(function () {
                        cb();
                    });
                }
            };
        }
    };
})
    .directive('ayAccordion', function () {
    return {
        restrict: 'A',
        require: ['ayAccordion', '^ayAccordionRoot'],
        controllerAs: 'accordion',
        bindToController: {
            onToggle: '&'
        },
        controller: function ($scope, $element, $attrs) {
            "ngInject";
            var self = this;
            self.rootCtrl = null;
            self.isOpen = false;
            self.open = function () {
                $element.addClass('open');
                $element[0].setAttribute('open', 'open');
                if ($element[0] === $element[0].parentNode.lastElementChild) {
                    $element[0].scrollIntoView();
                }
                $scope.$applyAsync(function () {
                    self.isOpen = true;
                });
                self['onToggle']({ state: true });
                if (!self.rootCtrl.multiple) {
                    self.rootCtrl.curPanel = self;
                }
            };
            self.close = function () {
                $element.removeClass('open');
                $element[0].removeAttribute('open');
                $scope.$applyAsync(function () {
                    self.isOpen = false;
                });
                self['onToggle']({ state: false });
                if (self.rootCtrl.curPanel === self) {
                    self.rootCtrl.curPanel = null;
                }
            };
            self.toggle = function (cb) {
                if (self.rootCtrl.blockClicks) {
                    return;
                }
                var fn = self.isOpen ? self.close : self.open;
                self.rootCtrl.run(fn, function () {
                    Array.prototype.forEach.call($element.children(), function (el) {
                        if (el.hasAttribute('ay-accordion-header')) {
                            return;
                        }
                        if (self.isOpen) {
                            el.removeAttribute('hidden');
                        }
                        else {
                            el.setAttribute('hidden', 'hidden');
                        }
                    });
                    cb();
                });
            };
        },
        link: function ($scope, $element, $attrs, $ctrls) {
            var selfCtrl = $ctrls[0];
            var rootCtrl = $ctrls[1];
            selfCtrl.rootCtrl = rootCtrl;
            Array.prototype.forEach.call($element.children(), function (el) {
                if (el.hasAttribute('ay-accordion-header')) {
                    return;
                }
                if ($element[0].hasAttribute('open')) {
                    el.removeAttribute('hidden');
                }
                else {
                    el.setAttribute('hidden', 'hidden');
                }
            });
            $attrs.$observe('open', function (newval) {
                if (newval != null) {
                    if (!$element.hasClass('open')) {
                        selfCtrl.open();
                    }
                }
                else if ($element.hasClass('open')) {
                    selfCtrl.close();
                }
            });
        }
    };
})
    .directive('ayAccordionHeader', function () {
    return {
        restrict: 'A',
        require: '^ayAccordion',
        scope: true,
        link: function ($scope, $element, $attrs, $ctrl) {
            $element[0].setAttribute('role', 'button');
            $element[0].setAttribute('tabIndex', '0');
            function updateState() {
                $element[0].setAttribute('aria-expanded', $ctrl.isOpen.toString());
            }
            function activate($event) {
                $ctrl.toggle(updateState);
                $event.preventDefault();
                return false;
            }
            $scope.$watch(function () { return $ctrl.isOpen; }, function () { return updateState(); });
            $element.on('click', function ($event) {
                $element[0].blur();
                return activate($event);
            });
            $element.on('keydown', function ($event) {
                if ($event.keyCode === 32 || $event.keyCode === 13) {
                    return activate($event);
                }
            });
        }
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWNjb3JkaW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2FjY29yZGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW1CRztBQWlCSCxPQUFPLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUM7S0FDaEMsU0FBUyxDQUFDLGlCQUFpQixFQUFFO0lBQzVCLE1BQU0sQ0FBQztRQUNMLFFBQVEsRUFBRSxHQUFHO1FBQ2IsVUFBVSxFQUFFLFVBQVMsTUFBTSxFQUFFLFFBQVEsRUFBRSxNQUFNO1lBQzNDLFVBQVUsQ0FBQztZQUVYLHdFQUF3RTtZQUN4RSxJQUFJLE1BQU0sR0FBSSxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQztZQUNyQyxJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQztZQUN0QyxJQUFJLEdBQUcsR0FBTyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQztZQUVsQyxJQUFJLEtBQUssR0FBSyxVQUFTLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBTTtnQkFDckMsSUFBSSxPQUFPLEdBQUcsQ0FBQyxFQUFFLEVBQUUsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUV2QyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDN0IsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDO3dCQUM3QyxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7b0JBQ3RDLENBQUM7Z0JBQ0gsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDTixHQUFHLENBQUMsQ0FB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QUMsQ0FBQztnQkFDMUIsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztLQUNGLENBQUM7QUFDSixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qISBDb3B5cmlnaHQgKGMpIDIwMTYgQXlvZ28gSGVhbHRoIEluYy5cbiAqXG4gKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4gKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0b1xuICogZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGVcbiAqIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vclxuICogc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4gKlxuICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuICpcbiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4gKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lOR1xuICogRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HU1xuICogSU4gVEhFIFNPRlRXQVJFLlxuICovXG5cbi8qIEBpbnRlcm5hbCAqL1xuaW50ZXJmYWNlIElQYW5lbENvbnRyb2xsZXIge1xuICByb290Q3RybCA6IGFueTtcbiAgaXNPcGVuIDogYm9vbGVhbjtcbiAgb3BlbiA6ICgpID0+IHZvaWQ7XG4gIGNsb3NlIDogKCkgPT4gdm9pZDtcbiAgdG9nZ2xlIDogKGNiIDogYW55KSA9PiB2b2lkO1xufVxuXG4vKiBAaW50ZXJuYWwgKi9cbmludGVyZmFjZSBJVGl0bGVTY29wZSBleHRlbmRzIG5nLklTY29wZSB7XG4gIGlzT3BlbiA6IGJvb2xlYW47XG59XG5cblxuYW5ndWxhci5tb2R1bGUoJ2F5QWNjb3JkaW9uJywgW10pXG4uZGlyZWN0aXZlKCdheUFjY29yZGlvblJvb3QnLCBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHtcbiAgICByZXN0cmljdDogJ0EnLFxuICAgIGNvbnRyb2xsZXI6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycykge1xuICAgICAgXCJuZ0luamVjdFwiO1xuXG4gICAgICAvLyBIZWxwZXIgTWV0aG9kcyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAgIHZhciBmaWx0ZXIgID0gQXJyYXkucHJvdG90eXBlLmZpbHRlcjtcbiAgICAgIHZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2g7XG4gICAgICB2YXIgbWFwICAgICA9IEFycmF5LnByb3RvdHlwZS5tYXA7XG5cbiAgICAgIHZhciBzdHlsZSAgID0gZnVuY3Rpb24oZWwsIHByb3AsIHZhbHVlPykge1xuICAgICAgICB2YXIgdmVuZG9ycyA9IFsnJywgJy13ZWJraXQtJywgJy1tcy0nXTtcblxuICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQodmFsdWUpKSB7XG4gICAgICAgICAgZm9yICh2YXIgaSA9IHZlbmRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHtcbiAgICAgICAgICAgIGVsLnN0eWxlW3ZlbmRvcnNbaV0gKyBwcm9wXSA9IHZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmb3IgKHZhciBpID0gdmVuZG9ycy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkge1xuICAgICAgICAgICAgaWYgKGVsLnN0eWxlW3ZlbmRvcnNbaV0gKyBwcm9wXSAhPT0gJycpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGVsLnN0eWxlW3ZlbmRvcnNbaV0gKyBwcm9wXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgIH07XG5cblxuICAgICAgLy8gQ29udHJvbGxlci1sZXZlbCBWYXJpYWJsZXMgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgICB0aGlzLnJvb3QgPSAkZWxlbWVudFswXTtcbiAgICAgIHRoaXMubXVsdGlwbGUgPSBhbmd1bGFyLmlzRGVmaW5lZCgkYXR0cnNbJ211bHRpcGxlJ10pO1xuICAgICAgdGhpcy5jdXJQYW5lbCA9IG51bGw7XG4gICAgICB0aGlzLmJsb2NrQ2xpY2tzID0gZmFsc2U7XG5cblxuICAgICAgLy8gQ29udHJvbGxlciBtZXRob2RzIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgICB0aGlzLnJ1biA9IGZ1bmN0aW9uKGZuLCBjYikge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgc2VsZi5ibG9ja0NsaWNrcyA9IHRydWU7XG5cbiAgICAgICAgdmFyIGVsZW1lbnRzVG9XYXRjaCA9IGZpbHRlci5jYWxsKHNlbGYucm9vdC5jaGlsZE5vZGVzLCBmdW5jdGlvbihlbCkge1xuICAgICAgICAgIC8qIERpc3JlZ2FyZCB0ZXh0IG5vZGVzIGFuZCBjb21tZW50cyAqL1xuICAgICAgICAgIHJldHVybiBlbC5ub2RlVHlwZSA9PT0gMTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdmFyIHByZVJvb3QgPSBzZWxmLnJvb3QuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgIHNlbGYucm9vdC5zdHlsZS5taW5IZWlnaHQgPSBwcmVSb290LmhlaWdodCArICdweCc7XG5cbiAgICAgICAgLyogVGFrZSBpbml0aWFsIG1lYXN1cmVtZW50cyAqL1xuICAgICAgICB2YXIgbWVhc3VyZW1lbnRzID0gbWFwLmNhbGwoZWxlbWVudHNUb1dhdGNoLCBmdW5jdGlvbihlbCkge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBlbDogZWwsXG4gICAgICAgICAgICBpbml0aWFsRGltZW5zaW9uczogIGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLFxuICAgICAgICAgICAgaW5pdGlhbFRyYW5zZm9ybTogICBzdHlsZShlbCwgJ3RyYW5zZm9ybScpIHx8ICcnXG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLyogQ2xvc2UgZXhpc3RpbmcgcGFuZWxzIGlmIG5lZWRlZCAqL1xuICAgICAgICBpZiAoIXRoaXMubXVsdGlwbGUgJiYgdGhpcy5jdXJQYW5lbCAmJiBmbiAhPT0gdGhpcy5jdXJQYW5lbC5jbG9zZSkge1xuICAgICAgICAgIHRoaXMuY3VyUGFuZWwuY2xvc2UoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qIFJ1biB0aGUgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBzdGF0ZSAqL1xuICAgICAgICBmbigpO1xuXG4gICAgICAgIC8qIFNldCB0aGUgZWxlbWVudCBzdGF0ZXMgdG8gYXBwZWFyIGFzIGluaXRpYWwgYWZ0ZXIgdGhlIGNoYW5nZSAqL1xuICAgICAgICBmb3JFYWNoLmNhbGwobWVhc3VyZW1lbnRzLCBmdW5jdGlvbihtKSB7XG4gICAgICAgICAgbS5uZXdEaW1lbnNpb25zID0gbS5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgICAgICAgIG0ubmV3U2NhbGUgPSB7XG4gICAgICAgICAgICB4OiBtLmluaXRpYWxEaW1lbnNpb25zLndpZHRoIC8gbS5uZXdEaW1lbnNpb25zLndpZHRoLFxuICAgICAgICAgICAgeTogbS5pbml0aWFsRGltZW5zaW9ucy5oZWlnaHQgLyBtLm5ld0RpbWVuc2lvbnMuaGVpZ2h0XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIG0ubmV3T2Zmc2V0ID0ge1xuICAgICAgICAgICAgeDogbS5pbml0aWFsRGltZW5zaW9ucy5sZWZ0IC0gbS5uZXdEaW1lbnNpb25zLmxlZnQsXG4gICAgICAgICAgICB5OiBtLmluaXRpYWxEaW1lbnNpb25zLnRvcCAtIG0ubmV3RGltZW5zaW9ucy50b3BcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgc3R5bGUobS5lbCwgJ3RyYW5zZm9ybS1vcmlnaW4nLCAnMCAwJyk7XG5cblxuICAgICAgICAgIG0uY2hpbGRyZW4gPSBbXTtcblxuICAgICAgICAgIC8qIFNldCB0aGUgZ3JhbmRjaGlsZHJlbiB0byB0aGUgaW52ZXJzZSB0cmFuc2Zvcm0gKi9cbiAgICAgICAgICBpZiAobS5pbml0aWFsRGltZW5zaW9ucy5oZWlnaHQgIT09IG0ubmV3RGltZW5zaW9ucy5oZWlnaHQgfHxcbiAgICAgICAgICAgICAgbS5pbml0aWFsRGltZW5zaW9ucy53aWR0aCAgIT09IG0ubmV3RGltZW5zaW9ucy53aWR0aCkge1xuXG4gICAgICAgICAgICBtLmNoaWxkcmVuID0gZmlsdGVyLmNhbGwobS5lbC5jaGlsZE5vZGVzLCBmdW5jdGlvbihlbCkge1xuICAgICAgICAgICAgICByZXR1cm4gZWwubm9kZVR5cGUgPT09IDE7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgZm9yRWFjaC5jYWxsKG0uY2hpbGRyZW4sIGZ1bmN0aW9uKGVsKSB7XG4gICAgICAgICAgICAgIHZhciBlbERpbWVuc2lvbnMgPSBlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgICAgICAgdmFyIG9mZnNldEZyb21QYXJlbnQgPSB7XG4gICAgICAgICAgICAgICAgeDogbS5uZXdEaW1lbnNpb25zLmxlZnQgLSBlbERpbWVuc2lvbnMubGVmdCxcbiAgICAgICAgICAgICAgICB5OiBtLm5ld0RpbWVuc2lvbnMudG9wICAtIGVsRGltZW5zaW9ucy50b3BcbiAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICB2YXIgb3JpZ2luID0gb2Zmc2V0RnJvbVBhcmVudC54ICsgJ3B4ICc7XG4gICAgICAgICAgICAgIG9yaWdpbiArPSBvZmZzZXRGcm9tUGFyZW50LnkgKyAncHgnO1xuXG4gICAgICAgICAgICAgIHN0eWxlKGVsLCAndHJhbnNmb3JtLW9yaWdpbicsIG9yaWdpbik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHZhciBkdXJhdGlvbiA9IDEwMDsgLy8gSW4gbWlsbGlzZWNvbmRzXG4gICAgICAgIHZhciB0ID0gMTtcblxuICAgICAgICBmdW5jdGlvbiB0d2VlbigpIHtcbiAgICAgICAgICBmb3JFYWNoLmNhbGwobWVhc3VyZW1lbnRzLCBmdW5jdGlvbihtKSB7XG4gICAgICAgICAgICBpZiAobS5pbml0aWFsRGltZW5zaW9ucy5oZWlnaHQgPT09IG0ubmV3RGltZW5zaW9ucy5oZWlnaHQgJiZcbiAgICAgICAgICAgICAgICBtLmluaXRpYWxEaW1lbnNpb25zLndpZHRoICA9PT0gbS5uZXdEaW1lbnNpb25zLndpZHRoICAmJlxuICAgICAgICAgICAgICAgIG0uaW5pdGlhbERpbWVuc2lvbnMubGVmdCAgID09PSBtLm5ld0RpbWVuc2lvbnMubGVmdCAgICYmXG4gICAgICAgICAgICAgICAgbS5pbml0aWFsRGltZW5zaW9ucy50b3AgICAgPT09IG0ubmV3RGltZW5zaW9ucy50b3ApIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciB0U2NhbGVYICAgPSAxICsgKG0ubmV3U2NhbGUueCAtIDEpICogdDtcbiAgICAgICAgICAgIHZhciB0U2NhbGVZICAgPSAxICsgKG0ubmV3U2NhbGUueSAtIDEpICogdDtcbiAgICAgICAgICAgIHZhciB0T2Zmc2V0WCAgPSBtLm5ld09mZnNldC54ICogdDtcbiAgICAgICAgICAgIHZhciB0T2Zmc2V0WSAgPSBtLm5ld09mZnNldC55ICogdDtcblxuICAgICAgICAgICAgdmFyIHRyYW5zZm9ybSA9ICd0cmFuc2xhdGUoJztcbiAgICAgICAgICAgIHRyYW5zZm9ybSArPSB0T2Zmc2V0WCArICdweCwgJztcbiAgICAgICAgICAgIHRyYW5zZm9ybSArPSB0T2Zmc2V0WSArICdweCkgJztcbiAgICAgICAgICAgIHRyYW5zZm9ybSArPSAnc2NhbGUoJyArIHRTY2FsZVggKyAnLCcgKyB0U2NhbGVZICsgJykgJztcbiAgICAgICAgICAgIHRyYW5zZm9ybSArPSBtLmluaXRpYWxUcmFuc2Zvcm07XG5cbiAgICAgICAgICAgIHN0eWxlKG0uZWwsICd0cmFuc2Zvcm0nLCB0cmFuc2Zvcm0pO1xuXG4gICAgICAgICAgICBmb3JFYWNoLmNhbGwobS5jaGlsZHJlbiwgZnVuY3Rpb24oZWwpIHtcbiAgICAgICAgICAgICAgdmFyIHNjYWxlID0gJ3NjYWxlKCcgKyAoMS90U2NhbGVYKSArICcsJyArICgxL3RTY2FsZVkpICsgJyknO1xuXG4gICAgICAgICAgICAgIHN0eWxlKGVsLCAndHJhbnNmb3JtJywgc2NhbGUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICB0IC09ICgxNiAvIGR1cmF0aW9uKTtcblxuICAgICAgICAgIGlmICh0ID4gMCkge1xuICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHR3ZWVuKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY2xlYW51cCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0d2VlbigpO1xuXG4gICAgICAgIGZ1bmN0aW9uIGNsZWFudXAoKSB7XG4gICAgICAgICAgZm9yRWFjaC5jYWxsKG1lYXN1cmVtZW50cywgZnVuY3Rpb24obSkge1xuICAgICAgICAgICAgc3R5bGUobS5lbCwgJ3RyYW5zZm9ybS1vcmlnaW4nLCAnJyk7XG4gICAgICAgICAgICBzdHlsZShtLmVsLCAndHJhbnNmb3JtJywgbS5pbml0aWFsVHJhbnNmb3JtKTtcblxuICAgICAgICAgICAgZm9yRWFjaC5jYWxsKG0uY2hpbGRyZW4sIGZ1bmN0aW9uKGVsKSB7XG4gICAgICAgICAgICAgIHN0eWxlKGVsLCAndHJhbnNmb3JtLW9yaWdpbicsICcnKTtcbiAgICAgICAgICAgICAgc3R5bGUoZWwsICd0cmFuc2Zvcm0nLCAnJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIHNlbGYuYmxvY2tDbGlja3MgPSBmYWxzZTtcbiAgICAgICAgICBzZWxmLnJvb3Quc3R5bGUubWluSGVpZ2h0ID0gbnVsbDtcblxuICAgICAgICAgIC8qIEludm9rZSBvdXIgY2FsbGJhY2sgZnVuY3Rpb24gd2hlbiBkb25lICovXG4gICAgICAgICAgJHNjb3BlLiRhcHBseUFzeW5jKCgpID0+IHtcbiAgICAgICAgICAgIGNiKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICB9O1xufSlcblxuLmRpcmVjdGl2ZSgnYXlBY2NvcmRpb24nLCBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHtcbiAgICByZXN0cmljdDogJ0EnLFxuICAgIHJlcXVpcmU6IFsnYXlBY2NvcmRpb24nLCAnXmF5QWNjb3JkaW9uUm9vdCddLFxuICAgIGNvbnRyb2xsZXJBczogJ2FjY29yZGlvbicsXG4gICAgYmluZFRvQ29udHJvbGxlcjoge1xuICAgICAgb25Ub2dnbGU6ICcmJ1xuICAgIH0sXG4gICAgY29udHJvbGxlcjogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzKSB7XG4gICAgICBcIm5nSW5qZWN0XCI7XG5cbiAgICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgICAgc2VsZi5yb290Q3RybCA9IG51bGw7XG4gICAgICBzZWxmLmlzT3BlbiA9IGZhbHNlO1xuXG4gICAgICBzZWxmLm9wZW4gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoJ29wZW4nKTtcbiAgICAgICAgJGVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCdvcGVuJywgJ29wZW4nKTtcblxuICAgICAgICBpZiAoJGVsZW1lbnRbMF0gPT09ICRlbGVtZW50WzBdLnBhcmVudE5vZGUubGFzdEVsZW1lbnRDaGlsZCkge1xuICAgICAgICAgICRlbGVtZW50WzBdLnNjcm9sbEludG9WaWV3KCk7XG4gICAgICAgIH1cblxuICAgICAgICAkc2NvcGUuJGFwcGx5QXN5bmMoKCkgPT4ge1xuICAgICAgICAgIHNlbGYuaXNPcGVuID0gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHNlbGZbJ29uVG9nZ2xlJ10oe3N0YXRlOiB0cnVlfSk7XG5cbiAgICAgICAgaWYgKCFzZWxmLnJvb3RDdHJsLm11bHRpcGxlKSB7XG4gICAgICAgICAgc2VsZi5yb290Q3RybC5jdXJQYW5lbCA9IHNlbGY7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIHNlbGYuY2xvc2UgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3MoJ29wZW4nKTtcbiAgICAgICAgJGVsZW1lbnRbMF0ucmVtb3ZlQXR0cmlidXRlKCdvcGVuJyk7XG5cbiAgICAgICAgJHNjb3BlLiRhcHBseUFzeW5jKCgpID0+IHtcbiAgICAgICAgICBzZWxmLmlzT3BlbiA9IGZhbHNlO1xuICAgICAgICB9KTtcbiAgICAgICAgc2VsZlsnb25Ub2dnbGUnXSh7c3RhdGU6IGZhbHNlfSk7XG5cblxuICAgICAgICBpZiAoc2VsZi5yb290Q3RybC5jdXJQYW5lbCA9PT0gc2VsZikge1xuICAgICAgICAgIHNlbGYucm9vdEN0cmwuY3VyUGFuZWwgPSBudWxsO1xuICAgICAgICB9XG4gICAgICB9O1xuXG5cbiAgICAgIHNlbGYudG9nZ2xlID0gZnVuY3Rpb24oY2IpIHtcbiAgICAgICAgaWYgKHNlbGYucm9vdEN0cmwuYmxvY2tDbGlja3MpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgZm4gPSBzZWxmLmlzT3BlbiA/IHNlbGYuY2xvc2UgOiBzZWxmLm9wZW47XG5cbiAgICAgICAgc2VsZi5yb290Q3RybC5ydW4oZm4sIGZ1bmN0aW9uKCkge1xuICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwoJGVsZW1lbnQuY2hpbGRyZW4oKSwgZnVuY3Rpb24oZWwpIHtcbiAgICAgICAgICAgIGlmIChlbC5oYXNBdHRyaWJ1dGUoJ2F5LWFjY29yZGlvbi1oZWFkZXInKSkge1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChzZWxmLmlzT3Blbikge1xuICAgICAgICAgICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoJ2hpZGRlbicpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCdoaWRkZW4nLCAnaGlkZGVuJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBjYigpO1xuICAgICAgICB9KTtcbiAgICAgIH07XG4gICAgfSxcbiAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsICRjdHJscykge1xuICAgICAgdmFyIHNlbGZDdHJsID0gJGN0cmxzWzBdO1xuICAgICAgdmFyIHJvb3RDdHJsID0gJGN0cmxzWzFdO1xuXG4gICAgICBzZWxmQ3RybC5yb290Q3RybCA9IHJvb3RDdHJsO1xuXG4gICAgICBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsKCRlbGVtZW50LmNoaWxkcmVuKCksIGZ1bmN0aW9uKGVsKSB7XG4gICAgICAgIGlmIChlbC5oYXNBdHRyaWJ1dGUoJ2F5LWFjY29yZGlvbi1oZWFkZXInKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICgkZWxlbWVudFswXS5oYXNBdHRyaWJ1dGUoJ29wZW4nKSkge1xuICAgICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZSgnaGlkZGVuJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCdoaWRkZW4nLCAnaGlkZGVuJyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICAkYXR0cnMuJG9ic2VydmUoJ29wZW4nLCBmdW5jdGlvbihuZXd2YWwpIHtcbiAgICAgICAgaWYgKG5ld3ZhbCAhPSBudWxsKSB7XG4gICAgICAgICAgaWYgKCEkZWxlbWVudC5oYXNDbGFzcygnb3BlbicpKSB7XG4gICAgICAgICAgICBzZWxmQ3RybC5vcGVuKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKCRlbGVtZW50Lmhhc0NsYXNzKCdvcGVuJykpIHtcbiAgICAgICAgICBzZWxmQ3RybC5jbG9zZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH07XG59KVxuXG4uZGlyZWN0aXZlKCdheUFjY29yZGlvbkhlYWRlcicsIGZ1bmN0aW9uKCkge1xuICByZXR1cm4ge1xuICAgIHJlc3RyaWN0OiAnQScsXG4gICAgcmVxdWlyZTogJ15heUFjY29yZGlvbicsXG4gICAgc2NvcGU6IHRydWUsIC8vIENoaWxkIHNjb3BlXG5cbiAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsICRjdHJsIDogSVBhbmVsQ29udHJvbGxlcikge1xuICAgICAgJGVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCdyb2xlJywgJ2J1dHRvbicpO1xuICAgICAgJGVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCd0YWJJbmRleCcsICcwJyk7XG5cbiAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0YXRlKCkge1xuICAgICAgICAkZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoJ2FyaWEtZXhwYW5kZWQnLCAkY3RybC5pc09wZW4udG9TdHJpbmcoKSk7XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIGFjdGl2YXRlKCRldmVudCkge1xuICAgICAgICAkY3RybC50b2dnbGUodXBkYXRlU3RhdGUpO1xuXG4gICAgICAgICRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgICRzY29wZS4kd2F0Y2goKCkgPT4gJGN0cmwuaXNPcGVuLCAoKSA9PiB1cGRhdGVTdGF0ZSgpKTtcblxuICAgICAgJGVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24oJGV2ZW50KSB7XG4gICAgICAgICRlbGVtZW50WzBdLmJsdXIoKTtcbiAgICAgICAgcmV0dXJuIGFjdGl2YXRlKCRldmVudCk7XG4gICAgICB9KTtcblxuICAgICAgJGVsZW1lbnQub24oJ2tleWRvd24nLCBmdW5jdGlvbigkZXZlbnQpIHtcbiAgICAgICAgaWYgKCRldmVudC5rZXlDb2RlID09PSAzMiB8fCAkZXZlbnQua2V5Q29kZSA9PT0gMTMpIHtcbiAgICAgICAgICByZXR1cm4gYWN0aXZhdGUoJGV2ZW50KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9O1xufSk7XG4iXX0=